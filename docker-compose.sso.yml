# Docker Compose Configuration for LibreChat with SSO
# This file provides an example configuration for running LibreChat with
# OpenID Connect SSO and optionally integrating with other services

version: '3.8'

services:
  # LibreChat API Service
  api:
    image: ghcr.io/danny-avila/librechat-dev-api:latest  # Use specific version in production, e.g., :v0.7.6
    container_name: librechat-api
    ports:
      - "${PORT:-3080}:${PORT:-3080}"
    depends_on:
      - mongodb
      - meilisearch
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Server Configuration
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-3080}
      - MONGO_URI=${MONGO_URI:-mongodb://mongodb:27017/LibreChat}
      - DOMAIN_CLIENT=${DOMAIN_CLIENT:-http://localhost:3080}
      - DOMAIN_SERVER=${DOMAIN_SERVER:-http://localhost:3080}
      
      # OpenID Connect SSO Configuration
      - OPENID_CLIENT_ID=${OPENID_CLIENT_ID}
      - OPENID_CLIENT_SECRET=${OPENID_CLIENT_SECRET}
      - OPENID_ISSUER=${OPENID_ISSUER}
      - OPENID_SESSION_SECRET=${OPENID_SESSION_SECRET}
      - OPENID_SCOPE=${OPENID_SCOPE:-openid profile email}
      - OPENID_CALLBACK_URL=${OPENID_CALLBACK_URL:-/oauth/openid/callback}
      - OPENID_BUTTON_LABEL=${OPENID_BUTTON_LABEL:-Sign in with SSO}
      - OPENID_IMAGE_URL=${OPENID_IMAGE_URL}
      - OPENID_AUTO_REDIRECT=${OPENID_AUTO_REDIRECT:-false}
      - OPENID_USE_PKCE=${OPENID_USE_PKCE:-true}
      - OPENID_AUDIENCE=${OPENID_AUDIENCE}
      
      # Role-Based Access Control
      - OPENID_REQUIRED_ROLE=${OPENID_REQUIRED_ROLE}
      - OPENID_REQUIRED_ROLE_TOKEN_KIND=${OPENID_REQUIRED_ROLE_TOKEN_KIND}
      - OPENID_REQUIRED_ROLE_PARAMETER_PATH=${OPENID_REQUIRED_ROLE_PARAMETER_PATH}
      - OPENID_ADMIN_ROLE=${OPENID_ADMIN_ROLE}
      - OPENID_ADMIN_ROLE_PARAMETER_PATH=${OPENID_ADMIN_ROLE_PARAMETER_PATH}
      - OPENID_ADMIN_ROLE_TOKEN_KIND=${OPENID_ADMIN_ROLE_TOKEN_KIND}
      
      # Claims Mapping
      - OPENID_USERNAME_CLAIM=${OPENID_USERNAME_CLAIM}
      - OPENID_NAME_CLAIM=${OPENID_NAME_CLAIM}
      
      # Token Management
      - OPENID_REUSE_TOKENS=${OPENID_REUSE_TOKENS}
      - OPENID_JWKS_URL_CACHE_ENABLED=${OPENID_JWKS_URL_CACHE_ENABLED}
      - OPENID_JWKS_URL_CACHE_TIME=${OPENID_JWKS_URL_CACHE_TIME}
      - OPENID_USE_END_SESSION_ENDPOINT=${OPENID_USE_END_SESSION_ENDPOINT}
      
      # Authentication Control
      - ALLOW_EMAIL_LOGIN=${ALLOW_EMAIL_LOGIN:-true}
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION:-false}
      - ALLOW_SOCIAL_LOGIN=${ALLOW_SOCIAL_LOGIN:-true}
      - ALLOW_SOCIAL_REGISTRATION=${ALLOW_SOCIAL_REGISTRATION:-false}
      
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - SESSION_EXPIRY=${SESSION_EXPIRY:-900000}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY:-604800000}
      
      # Meilisearch Configuration
      - SEARCH=${SEARCH:-true}
      - MEILI_HOST=${MEILI_HOST:-http://meilisearch:7700}
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      
      # Debugging
      - DEBUG_LOGGING=${DEBUG_LOGGING:-false}
      - DEBUG_OPENID_REQUESTS=${DEBUG_OPENID_REQUESTS:-false}
      
      # Proxy Configuration
      - PROXY=${PROXY}
      - TRUST_PROXY=${TRUST_PROXY:-1}
    volumes:
      - ./images:/app/client/public/images
      - ./logs:/app/api/logs
    networks:
      - librechat-network

  # LibreChat Client (Web UI)
  client:
    image: ghcr.io/danny-avila/librechat-dev:latest  # Use specific version in production, e.g., :v0.7.6
    container_name: librechat-client
    depends_on:
      - api
    restart: always
    networks:
      - librechat-network

  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: librechat-mongodb
    restart: always
    volumes:
      - mongodb-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=LibreChat
    networks:
      - librechat-network

  # Meilisearch (Search Engine)
  meilisearch:
    image: getmeili/meilisearch:v1.5.1
    container_name: librechat-meilisearch
    restart: always
    volumes:
      - meilisearch-data:/meili_data
    environment:
      - MEILI_HOST=${MEILI_HOST:-http://0.0.0.0:7700}
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_NO_ANALYTICS=${MEILI_NO_ANALYTICS:-true}
    networks:
      - librechat-network

  # Optional: Keycloak Identity Provider
  # Uncomment this section to run Keycloak as your SSO provider
  # keycloak:
  #   image: quay.io/keycloak/keycloak:26.0  # Use specific version for production
  #   container_name: keycloak
  #   environment:
  #     - KEYCLOAK_ADMIN=admin
  #     - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
  #     - KC_DB=postgres
  #     - KC_DB_URL=jdbc:postgresql://keycloak-db:5432/keycloak
  #     - KC_DB_USERNAME=keycloak
  #     - KC_DB_PASSWORD=${KC_DB_PASSWORD}
  #     - KC_HOSTNAME=${KEYCLOAK_HOSTNAME:-localhost}
  #     - KC_HTTP_ENABLED=true
  #   command: start-dev
  #   ports:
  #     - "8080:8080"
  #   depends_on:
  #     - keycloak-db
  #   restart: always
  #   networks:
  #     - librechat-network

  # Optional: PostgreSQL for Keycloak
  # keycloak-db:
  #   image: postgres:15-alpine
  #   container_name: keycloak-db
  #   environment:
  #     - POSTGRES_DB=keycloak
  #     - POSTGRES_USER=keycloak
  #     - POSTGRES_PASSWORD=${KC_DB_PASSWORD}
  #   volumes:
  #     - keycloak-db-data:/var/lib/postgresql/data
  #   restart: always
  #   networks:
  #     - librechat-network

  # Optional: LiteLLM Integration
  # Uncomment to run LiteLLM with SSO
  # litellm:
  #   image: ghcr.io/berriai/litellm:main-latest
  #   container_name: litellm
  #   volumes:
  #     - ./litellm/litellm-config.yaml:/app/config.yaml
  #   ports:
  #     - "4000:8000"
  #   command: ["--config", "/app/config.yaml", "--port", "8000", "--num_workers", "8"]
  #   environment:
  #     # LiteLLM SSO Configuration
  #     - UI_OAUTH_PROVIDER=openid
  #     - OIDC_ISSUER=${OPENID_ISSUER}
  #     - OIDC_CLIENT_ID=${LITELLM_CLIENT_ID}
  #     - OIDC_CLIENT_SECRET=${LITELLM_CLIENT_SECRET}
  #     - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
  #   restart: always
  #   networks:
  #     - librechat-network

  # Optional: OpenWebUI Integration
  # Uncomment to run OpenWebUI with SSO
  # openwebui:
  #   image: ghcr.io/open-webui/open-webui:main
  #   container_name: openwebui
  #   ports:
  #     - "8080:8080"
  #   volumes:
  #     - openwebui-data:/app/backend/data
  #   environment:
  #     # OpenWebUI SSO Configuration
  #     - ENABLE_OAUTH_SIGNUP=true
  #     - OAUTH_PROVIDER_NAME=SSO
  #     - OPENID_PROVIDER_URL=${OPENID_ISSUER}/.well-known/openid-configuration
  #     - OAUTH_CLIENT_ID=${OPENWEBUI_CLIENT_ID}
  #     - OAUTH_CLIENT_SECRET=${OPENWEBUI_CLIENT_SECRET}
  #     - OAUTH_SCOPES=openid profile email
  #   restart: always
  #   networks:
  #     - librechat-network

networks:
  librechat-network:
    driver: bridge

volumes:
  mongodb-data:
  meilisearch-data:
  # keycloak-db-data:
  # openwebui-data:
